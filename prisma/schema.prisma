generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "mysql"
}

model mydata {
  id     Int     @id @default(autoincrement()) @db.UnsignedInt
}

model user{ // 하나은행 계좌 보유자, 부모 자녀 통합 
  id        Int     @id @default(autoincrement()) @db.UnsignedInt
  mydata_id Int?    @unique @db.UnsignedInt 
  born_date        DateTime  @db.Date
  name             String    @db.VarChar(50)
  profile_pic      String?   @db.VarChar(255)
  goal_money       BigInt?   @db.UnsignedBigInt // 증여 플랜에 따른 목표 금액
  monthly_money    BigInt?   @db.UnsignedBigInt // 증여 플랜에 따른 월 납입 금액
  is_promise_fixed Boolean?   @default(false) // 유기정기금 yes(1), no(0)
  invest_type      invest_type? @default(NOBASE) // 투자 성향 (NOBASE, DEFENSIVE, OFFENSIVE, DOPAMINE)
  identity_hash    String     @unique @db.VarChar(255)
  start_date       DateTime?  @db.Date       // 증여 플랜 시작날짜
  end_date         DateTime?  @db.Date       // 증여 플랜 종료날짜  
  reading_list  read_auth[] @relation("ReaderRelation") // 권한 관계: 내가 누구의 정보를 볼 수 있는지
  provided_to   read_auth[] @relation("ProviderRelation")// 권한 관계: 누가 나의 정보를 볼 수 있는지
  account          account[]  
  alert            alert[]
  timeline timeline[]
}


model fund {
  id          Int              @id @default(autoincrement()) @db.UnsignedInt
  name        String           @db.VarChar(255)
  danger      fund_danger
  type        fund_type         // 채권, 주식 등 펀드 유형 + 신탁
  is_pension   Boolean           @default(false) // 연저펀 전용(1), 일반펀드(0)
  saving_type fund_saving_type  // 적립 방식: 정기+자유(BOTH), 정기만(REGULAR), 자유만(FREE)
  company     String            @db.VarChar(50)
  total_fee   Decimal      @db.Decimal(5, 4)
  sell_fee    Decimal      @db.Decimal(5, 4)
  set_date    DateTime     @db.Date      // 상장일
  maturity_period Int?      @db.UnsignedInt  // [만기 기간] 개월 수 (ETF는 null, 펀드/신탁은 12, 36, 60 등)
  plus_1      Decimal?     @db.Decimal(7, 2) // Optional 상장 1,5,10년 안된애들 있을수있음
  plus_5      Decimal?     @db.Decimal(7, 2) // Optional
  plus_10     Decimal?     @db.Decimal(7, 2) // Optional
  total_money BigInt       @db.UnsignedBigInt
  image       String       @db.VarChar(255)
  account     account[]
}
/*
유저 테이블에 자녀 추가하고 account랑 묶기, working account에 outer join으로 누가 얼마 줬는지 확인가능하도록 
account - 하나은행 계좌만 취급
*/
model account {
  id                                         Int               @id @default(autoincrement()) @db.UnsignedInt
  fund_id                                    Int?              @db.UnsignedInt
  user_id                                    Int               @db.UnsignedInt
  // 연금저축펀드계좌 표시. 일반펀드/예적금/ETF계좌는 null
  // sub_accounts가 연저펀에서 굴리는 펀드들임
  parent_account_id                          Int?              @db.UnsignedInt 
  parent_account                             account?          @relation("ParentSub", fields: [parent_account_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  sub_accounts                               account[]         @relation("ParentSub")
  acc_num                                    String            @unique @db.VarChar(30)
  acc_type                                   account_acc_type
  opened_at                                  DateTime          @db.Date
  target_date                                DateTime?         @db.Date  // 가입 시 계산된 만기 예정일 (ETF는 null)
  closed_at                                  DateTime?         @db.Date
  deposit                                    BigInt            @default(0) @db.UnsignedBigInt //원금
  in_type                                    Boolean           @default(false) // 0=정기(false), 1=자유(true)
  plus_rate                                  Decimal           @default(0.00) @db.Decimal(5, 2) //수익률
  plus_money                                 BigInt            @default(0) @db.UnsignedBigInt //수익금
  in_month                                   Int?              @db.TinyInt //납입 개월 
  status                                     account_status    @default(ACTIVE) // Enum 추가
  user                                     user             @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_account_user")
  fund                                       fund?             @relation(fields: [fund_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_account_fund")
  history_history_source_account_idToaccount history[]         @relation("history_source_account_idToaccount")
  history_history_target_account_idToaccount history[]         @relation("history_target_account_idToaccount")
  auto_transfer_source                       auto_transfer[]   @relation("auto_transfer_source")
  auto_transfer_target                       auto_transfer[]   @relation("auto_transfer_target")

  @@index([user_id], map: "fk_account_user")
  @@index([fund_id], map: "fk_account_fund")
  @@index([parent_account_id], map: "fk_parent_pension")
}

model history {
  id                                         BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  created_at                                 DateTime @default(now()) @db.DateTime(6)
  money                                      BigInt   @db.UnsignedBigInt
  source_account_id                          Int?      @db.UnsignedInt
  target_account_id                          Int      @db.UnsignedInt
  account_history_source_account_idToaccount account?  @relation("history_source_account_idToaccount", fields: [source_account_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_history_source")
  account_history_target_account_idToaccount account  @relation("history_target_account_idToaccount", fields: [target_account_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_history_target")
  etc               String?  @db.VarChar(30) //타 은행에서 송금한 경우 etc에 명시
  
  @@index([source_account_id], map: "fk_history_source")
  @@index([target_account_id], map: "fk_history_target")
}

model auto_transfer {
  id                Int     @id @default(autoincrement()) @db.UnsignedInt
  transfer_day      Int     @db.UnsignedTinyInt
  transfer_count    Int     @db.UnsignedTinyInt
  amount            BigInt  @db.UnsignedBigInt
  source_account_id Int     @db.UnsignedInt
  target_account_id Int     @db.UnsignedInt
  source_account    account? @relation("auto_transfer_source", fields: [source_account_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_auto_transfer_source")
  target_account    account @relation("auto_transfer_target", fields: [target_account_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_auto_transfer_target")

  @@index([source_account_id], map: "fk_auto_transfer_source")
  @@index([target_account_id], map: "fk_auto_transfer_target")
}

//안씀
model alert {
  id          Int      @id @default(autoincrement()) @db.UnsignedInt
  user_id    Int      @db.UnsignedInt
  type        String   @db.VarChar(25)
  title       String   @db.VarChar(25)
  description String?  @db.Text
  button_text String   @default("확인") @db.VarChar(20)
  status      Boolean  @default(false)
  priority    Int      @default(0) @db.UnsignedTinyInt
  created_at  DateTime @default(now()) @db.DateTime(6)
  screen      String   @db.VarChar(50)
  user       user    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_alert_user")

  @@index([user_id], map: "fk_alert_user")
}

model timeline {
  id          Int      @id @default(autoincrement()) @db.UnsignedInt
  user_id    Int      @db.UnsignedInt
  date        DateTime @default(now()) @db.DateTime(6)
  type        String   @db.VarChar(20)
  description String?  @db.VarChar(50)
  memo        String?  @db.VarChar(50)

  user       user    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_timeline_user")
  @@index([user_id], map: "fk_timeline_user")
}

//아이앞으로에서 누구 프로필을 볼건지, speed계좌 조회와는 별도의 테이블임 
model read_auth {
  id Int @id @default(autoincrement()) @db.UnsignedInt
  reader_id Int @db.UnsignedInt
  provider_id Int @db.UnsignedInt

  reader user @relation("ReaderRelation", fields: [reader_id], references: [id], onDelete: Cascade)
  provider user @relation("ProviderRelation", fields: [provider_id], references: [id], onDelete: Cascade)
 
  @@index([reader_id], map: "fk_read_auth_reader")
  @@index([provider_id], map: "fk_read_auth_provider")
  @@unique([reader_id, provider_id])
}
enum fund_danger {
  LOW
  MID
  HIGH
}

enum invest_type {
  NOBASE
  DEFENSIVE
  OFFENSIVE
  DOPAMINE
}

enum fund_type {
  STOCK       // 주식형
  BOND        // 채권형
  MIXED       // 혼합형
  ETF         // 상장지수펀드
  TRUST       // 신탁형
}

enum fund_saving_type {
  BOTH
  REGULAR
  FREE
}

enum account_acc_type {
  GIFT_DEPOSIT //증여용 통장
  DEPOSIT //입출금 통장
  FUND
  PENSION
}

enum account_status {
  ACTIVE             // 운용 중 (공통)
  
  SOLD               // ETF 전용: 전량 매도 (해지 개념 아님)
  
  EARLY_TERMINATED   // 펀드/신탁: 중도 해지 (기간 못 채움)
  MATURITY_TERMINATED // 펀드/신탁: 만기 해지 (기간 채움)
}
