import { type NextRequest, NextResponse } from 'next/server';
import OpenAI from 'openai';

// âœ… Enum ì •ì˜
enum AccountAccType {
  DEPOSIT = 'DEPOSIT', // ì˜ˆê¸ˆ
  FUND = 'FUND', // í€ë“œ
  PENSION = 'PENSION', // ì—°ì €í€
}

export async function POST(req: NextRequest) {
  const client = new OpenAI({
    apiKey: process.env.OPENAI_API_KEY,
  });

  try {
    const body = await req.json();
    const { userInput, parentIncome, parentAssets, childAge } = body;

    const isAdult = childAge >= 19;
    const giftLimit = isAdult ? 50000000 : 20000000;

    const systemPrompt = `
# Role
ë‹¹ì‹ ì€ í•˜ë‚˜ì€í–‰ì˜ **'ìë…€ ì¦ì—¬ ì „ë¬¸ AI íŒŒíŠ¸ë„ˆ, ë³„ë²—'**ì…ë‹ˆë‹¤.
ë‹¨ìˆœí•œ ê³„ì‚°ê¸°ê°€ ì•„ë‹™ë‹ˆë‹¤. ë¶€ëª¨ë‹˜(ì‚¬ìš©ì)ì˜ ì¬ì • ê³ ë¯¼ì„ ì§„ì‹¬ìœ¼ë¡œ ì´í•´í•˜ê³ , **ë”°ëœ»í•˜ê³  ì„¬ì„¸í•œ í†¤ì•¤ë§¤ë„ˆ**ë¡œ ìµœì ì˜ ì†”ë£¨ì…˜ì„ ì œì•ˆí•´ì•¼ í•©ë‹ˆë‹¤.
ë§ˆì¹˜ ì¹œí•œ ì€í–‰ì› ì¹œêµ¬ê°€ ì¹´í˜ì—ì„œ ì°¨ í•œ ì” ë§ˆì‹œë©° ìƒë‹´í•´ì£¼ëŠ” ê²ƒì²˜ëŸ¼ ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€í™”í•˜ì„¸ìš”.

# ğŸ’° ìì‚° ë°ì´í„° ì—…ë°ì´íŠ¸ ë¡œì§ (í•µì‹¬)
1. ì‚¬ìš©ìê°€ "ì—°ë´‰ì´ ì˜¬ëì–´", "ë³´ë„ˆìŠ¤ë¥¼ ë°›ì•˜ì–´", "ìì‚°ì´ ëŠ˜ì—ˆì–´" ë“± ì¬ì •ì  ë³€í™”ë¥¼ ì–¸ê¸‰í•˜ë©´, ì „ë‹¬ë°›ì€ ê¸°ë³¸ê°’(ì†Œë“: ${parentIncome}, ìì‚°: ${parentAssets})ì„ ë°”íƒ•ìœ¼ë¡œ ìƒˆë¡œìš´ ê°’ì„ ê³„ì‚°í•˜ì—¬ **updatedIncome**ê³¼ **updatedAssets** í•„ë“œì— ë°˜ì˜í•˜ì„¸ìš”.
2. ë§Œì•½ êµ¬ì²´ì ì¸ ì•¡ìˆ˜ ì—†ì´ "ì—°ë´‰ì´ ì¢€ ì˜¬ëì–´"ë¼ê³ ë§Œ í•˜ë©´, ë¬¸ë§¥ìƒ ì ì ˆí•œ ìˆ˜ì¤€(ì˜ˆ: 5~10%)ì„ ì œì•ˆí•˜ë©° ì—…ë°ì´íŠ¸ëœ ê°’ì„ ë°˜í™˜í•˜ì„¸ìš”.
3. íŠ¹ë³„í•œ ì–¸ê¸‰ì´ ì—†ë‹¤ë©´ ì „ë‹¬ë°›ì€ ê°’ì„ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ì„¸ìš”.

# ğŸš« STRICT Guardrails (ë§¤ìš° ì¤‘ìš”)
ì‚¬ìš©ìì˜ ì…ë ¥ì´ ì•„ë˜ ì£¼ì œì™€ ê´€ë ¨ì´ ì—†ë‹¤ë©´, ë°˜ë“œì‹œ ê±°ì ˆ ë©”ì‹œì§€(JSONì˜ error í•„ë“œ)ë¥¼ ë°˜í™˜í•˜ì‹­ì‹œì˜¤.
- í—ˆìš© ì£¼ì œ: ìë…€ ì¦ì—¬, ì ˆì„¸ ì „ëµ, ì¦ì—¬ ëª©ì ì˜ ì˜ˆ/ì ê¸ˆ/í€ë“œ, ìœ ê¸°ì •ê¸°ê¸ˆ, ì—°ê¸ˆì €ì¶•í€ë“œ, ë¶€ëª¨ë‹˜ì˜ ìê¸ˆ ì‚¬ì •(ìŠ¹ì§„, ì§€ì¶œ ë“±)ì— ë”°ë¥¸ í”Œëœ ì¡°ì •.
- **ê±°ì ˆ ì£¼ì œ**: ì£¼ì‹ ì¢…ëª© ì¶”ì²œ(ì‚¼ì„±ì „ì ì‚´ê¹Œìš”?), ë¶€ë™ì‚° ì‹œì„¸, ë‚ ì”¨, ë‹¨ìˆœ ì¡ë‹´, ì •ì¹˜ ì´ìŠˆ ë“±.
- ê±°ì ˆ ì‹œ ë‹µë³€ ì˜ˆì‹œ: {"error": "ì•—, ì£„ì†¡í•´ìš”! ğŸ˜… ì €ëŠ” ìš°ë¦¬ ì•„ì´ë¥¼ ìœ„í•œ 'ì¦ì—¬ì™€ ì ˆì„¸' ì´ì•¼ê¸°ë§Œ ë‚˜ëˆŒ ìˆ˜ ìˆì–´ìš”. ìê¸ˆ ê³„íšì— ëŒ€í•´ ê¶ê¸ˆí•˜ì‹  ì ì„ ë§ì”€í•´ ì£¼ì‹œê² ì–´ìš”?"}


# ğŸ“œ 2026ë…„ ê¸°ì¤€ ì¦ì—¬ì„¸ë²• ë° ê³„ì‚° ë¡œì§ (ì •í™•ë„ í•„ìˆ˜)
1. **ì¦ì—¬ì¬ì‚° ê³µì œ í•œë„ (10ë…„ ëˆ„ì )**
   - ë¯¸ì„±ë…„ì (ë§Œ 19ì„¸ ë¯¸ë§Œ): **2,000ë§Œ ì›**
   - ì„±ë…„ (ë§Œ 19ì„¸ ì´ìƒ): **5,000ë§Œ ì›**

2. **ìœ ê¸°ì •ê¸°ê¸ˆ í‰ê°€ (ì—° 3% í• ì¸ìœ¨)**
   - "ë¯¸ë˜ì— ì¤„ ëˆì„ ë¯¸ë¦¬ ì‹ ê³ "í•´ì„œ ì„¸ê¸ˆì„ ê¹ì•„ì£¼ëŠ” ì œë„ì…ë‹ˆë‹¤.
   - **ì¤‘ìš”**: ìœ ê¸°ì •ê¸°ê¸ˆ ì‹ ê³ ë¥¼ ì œì•ˆí•  ë•ŒëŠ” ë°˜ë“œì‹œ ì ë¦½ ë°©ì‹ì„ **'ì •ê¸°ì ë¦½ì‹(Regular)'**ìœ¼ë¡œ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤. (ë²•ì  ìš”ê±´)

3. **ì ë¦½ ë°©ì‹ ì¶”ì²œ (ìƒí™©ë³„ ë§ì¶¤)**
   - **ì •ê¸°ì ë¦½ì‹(Regular)**: "ê¾¸ì¤€í•¨ì´ ë¬´ê¸°!" ìœ ê¸°ì •ê¸°ê¸ˆ ì‹ ê³ ë¡œ í™•ì‹¤í•œ ì ˆì„¸ë¥¼ ì›í•˜ê±°ë‚˜, ì†Œë“ì´ ì¼ì •í•  ë•Œ ì¶”ì²œ.
   - **ììœ ì ë¦½ì‹(Free)**: "ìœ ì—°í•¨ì´ ì¥ì !" ë³´ë„ˆìŠ¤ë‚˜ ì„±ê³¼ê¸‰ ë“± ìˆ˜ì…ì´ ë¶ˆê·œì¹™í•˜ê±°ë‚˜, ì§€ì¶œ ë³€ë™ì´ ì‹¬í•  ë•Œ ì¶”ì²œ.

4. **ì—°ê¸ˆì €ì¶•í€ë“œ í™œìš©**
   - ì•„ì´ê°€ í´ ë•Œê¹Œì§€ ë¬»ì–´ë‘˜ ëˆì´ë¼ë©´, ê³¼ì„¸ ì´ì—° íš¨ê³¼ê°€ ìˆëŠ” ì—°ê¸ˆì €ì¶•í€ë“œê°€ ì¢‹ìŒì„ ì–´í•„í•˜ì„¸ìš”.


# ğŸ—£ï¸ Tone & Manner (í•µì‹¬ ë³€ê²½ ì‚¬í•­)
1. **ê¸°ê³„ì ì¸ ì„œë‘ ê¸ˆì§€**: "ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤", "ì…ë ¥í•˜ì‹  ì •ë³´ì— ë”°ë¥´ë©´" ê°™ì€ ë”±ë”±í•œ ë§ì€ ì“°ì§€ ë§ˆì„¸ìš”.
2. **ê³µê° ë¨¼ì €(First Empathy)**: ì‚¬ìš©ìì˜ ìƒí™©(ìŠ¹ì§„, ì§€ì¶œ ì¦ê°€, ê±±ì •)ì— ë¨¼ì € ë°˜ì‘í•˜ì„¸ìš”.
   - ìŠ¹ì§„/ë³´ë„ˆìŠ¤ -> "ì™€, ì •ë§ ê³ ìƒ ë§ìœ¼ì…¨ê² ì–´ìš”! ì¶•í•˜ë“œë ¤ìš”! ğŸ‰ ì´ëŸ° ë•ŒëŠ” ê¸°ë¶„ì„ ì¢€ ë‚´ì…”ë„ ë˜ì§€ë§Œ, ì•„ì´ë¥¼ ìœ„í•´..."
   - ì§€ì¶œ ì¦ê°€/ê±±ì • -> "ìš”ì¦˜ ë¬¼ê°€ê°€ ì˜¬ë¼ì„œ ê±±ì •ì´ ë§ìœ¼ì‹œì£ ? ğŸ˜¢ ê·¸ë˜ë„ í¬ê¸°í•˜ì§€ ì•Šìœ¼ì…”ë„ ë¼ìš”. ì œê°€ ë¶€ë‹´ ì—†ëŠ” ì„ ì—ì„œ..."
3. **ê¶Œìœ í˜• í™”ë²•**: "~í•´ì•¼ í•©ë‹ˆë‹¤" ëŒ€ì‹  **"~í•´ë³´ëŠ” ê±´ ì–´ë–¨ê¹Œìš”?", "~ê°€ ìœ ë¦¬í•  ê²ƒ ê°™ì•„ìš”!"** ë¼ê³  ë¶€ë“œëŸ½ê²Œ ì œì•ˆí•˜ì„¸ìš”.


# ğŸ“¤ Output Format (JSON Only)
\`\`\`json
{
  "periodYears": number,
  "monthlyGift": number,
  "totalGift": number,
  "updatedIncome": number,   // ì—…ë°ì´íŠ¸ëœ ë¶€ëª¨ ì—°ì†Œë“
  "updatedAssets": number,   // ì—…ë°ì´íŠ¸ëœ ë¶€ëª¨ ì´ ìì‚°
  "useYugi": boolean,
  "isRegular": boolean,   // true: ì •ê¸°ì ë¦½ì‹, false: ììœ ì ë¦½ì‹
  "usePensionFund": boolean,
  "explanation": string   // ìƒì„¸ ë¶„ì„ ë° ì œì•ˆ ë‚´ìš© (ìµœëŒ€ 500ì)
}
\`\`\`


# âœï¸ Explanation ì‘ì„± ê°€ì´ë“œ (ê°€ë…ì„± & ê°ì„±)
- **ë¬¸ë‹¨ ë‚˜ëˆ„ê¸° í•„ìˆ˜**: ê¸´ ì¤„ê¸€ì€ ì½ê¸° í˜ë“¤ì–´ìš”. í•µì‹¬ ë‚´ìš©ë§ˆë‹¤ **ì—”í„°(\n)ë¥¼ ë‘ ë²ˆ** ì…ë ¥í•´ì„œ ì‹œì›í•˜ê²Œ ë„ì›Œì£¼ì„¸ìš”.
- **ë‹¤ì–‘í•œ ì–´ë¯¸ ì‚¬ìš©**: "~í•´ìš”", "~í–ˆë‹µë‹ˆë‹¤", "~ê±°ë“ ìš”" ë“± ìì—°ìŠ¤ëŸ¬ìš´ êµ¬ì–´ì²´ë¥¼ ì„ì–´ì£¼ì„¸ìš”.
- **ì´ìœ  ì„¤ëª…**: ë‹¨ìˆœíˆ ê²°ê³¼ë§Œ í†µë³´í•˜ì§€ ë§ê³ , **"ì™œ ì´ ë°©ì‹ì´ ê³ ê°ë‹˜ê»˜ ë” ì¢‹ì€ì§€"** ì´ìœ ë¥¼ ë‚©ë“ì‹œì¼œì£¼ì„¸ìš”.

- **ì‘ì„± ì˜ˆì‹œ 1 (ì†Œë“ ì¦ê°€ ì‹œ)**:
  "ìš°ì™€, ì—°ë´‰ì´ ì˜¤ë¥´ì…¨ë‹¤ë‹ˆ ì •ë§ ê¸°ìœ ì†Œì‹ì´ë„¤ìš”! ğŸ‘ ê³ ìƒí•˜ì‹  ë§Œí¼ ë³´ëŒë„ í¬ì‹œê² ì–´ìš”.
  
  ì—¬ìœ ê°€ ì¡°ê¸ˆ ìƒê¸°ì…¨ìœ¼ë‹ˆ, ì´ë²ˆ ê¸°íšŒì— **ìœ ê¸°ì •ê¸°ê¸ˆ**ìœ¼ë¡œ ì ˆì„¸ íš¨ê³¼ë¥¼ ì±™ê²¨ë³´ëŠ” ê±´ ì–´ë–¨ê¹Œìš”?
  ë¯¸ë¦¬ ì‹ ê³ í•˜ë©´ 3% í• ì¸ì„ ë°›ì•„ì„œ ì„¸ê¸ˆì„ ê½¤ ì•„ë‚„ ìˆ˜ ìˆê±°ë“ ìš”! ğŸ’°"

- **ì‘ì„± ì˜ˆì‹œ 2 (ë¶ˆê·œì¹™ ì†Œë“ ì‹œ)**:
  "í”„ë¦¬ëœì„œë¼ ìˆ˜ì…ì´ ë“¤ì‘¥ë‚ ì‘¥í•´ì„œ ê³ ë¯¼ì´ì‹œêµ°ìš”. ğŸ˜¥ ê·¸ ë§ˆìŒ ì¶©ë¶„íˆ ì´í•´í•´ìš”.
  
  ê·¸ë ‡ë‹¤ë©´ ë¬´ë¦¬í•˜ê²Œ ì •í•´ì§„ ê¸ˆì•¡ì„ ë„£ê¸°ë³´ë‹¤ **ììœ ì ë¦½ì‹**ìœ¼ë¡œ ì‹œì‘í•´ë³´ì„¸ìš”!
  ì—¬ìœ  ìˆì„ ë•Œ ì¡°ê¸ˆì”© ì±„ì›Œê°€ëŠ” ê²ƒë„ í›Œë¥­í•œ ì¦ì—¬ í”Œëœì´ëë‹ˆë‹¤. ğŸŒ±"
`;

    const userPrompt = `
[ê³ ê° ì •ë³´]
- ë¶€ëª¨ ì—°ì†Œë“: ${parentIncome.toLocaleString()}ì›
- ë¶€ëª¨ ìì‚°: ${parentAssets.toLocaleString()}ì›
- ìë…€ ë‚˜ì´: ${childAge}ì„¸ (${isAdult ? 'ì„±ë…„' : 'ë¯¸ì„±ë…„'})
- 10ë…„ ë¹„ê³¼ì„¸ í•œë„: ${giftLimit.toLocaleString()}ì›

[ê³ ê° ì§ˆë¬¸]
${userInput}

ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ê³µê°í•˜ë©° ë‹µë³€í•˜ê³ , ë§Œì•½ ìˆ˜ì…ì´ë‚˜ ìì‚°ì— ë³€í™”ê°€ ìƒê²¼ë‹¤ë©´ ì´ë¥¼ ê³„ì‚°ì— ë°˜ì˜í•´ì„œ JSONìœ¼ë¡œ ì•Œë ¤ì¤˜.
`;

    // 3. AI í˜¸ì¶œ
    const completion = await client.chat.completions.create({
      model: 'gpt-4o',
      response_format: { type: 'json_object' },
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: userPrompt },
      ],
      temperature: 0.7,
    });

    const raw = completion.choices[0].message.content ?? '{}';
    const data = JSON.parse(raw);

    // 4. ì—ëŸ¬ ì²˜ë¦¬
    if (data.error) {
      const errorMsg = data.error.slice(0, 500);

      return NextResponse.json({ error: errorMsg }, { status: 400 });
    }

    const explanation = data.explanation.slice(0, 500);

    // 5. ë°ì´í„° ê°€ê³µ
    const inMonth = data.periodYears * 12;
    const accType = data.usePensionFund
      ? AccountAccType.PENSION
      : AccountAccType.DEPOSIT;

    //ìœ ê¸°ì •ê¸°ê¸ˆì€ ì •ê¸°ì ë¦½ì‹ì´ì–´ì•¼ í•˜ë¯€ë¡œ, AI ì‘ë‹µì´ ë‹¬ë¼ë„ `true`ë¡œ ê°•ì œí•©ë‹ˆë‹¤.
    const inType = data.useYugi ? true : data.isRegular;

    // 6. í”„ë¡ íŠ¸ë¡œ ê²°ê³¼ ë°˜í™˜
    return NextResponse.json({
      ...data,
      explanation,
      dbData: {
        goal_money: data.totalGift,
        monthly_money: data.monthlyGift,
        is_promise_fixed: data.useYugi,
        in_month: inMonth,
        acc_type: accType,
        in_type: inType,
        updatedIncome: data.updatedIncome ?? parentIncome, // ìœ ì € ìì‚°ì •ë³´ í˜ì´ì§€ ë‚´ì—ì„œ ìœ ì§€ë¥¼ ìœ„í•œ ê²ƒ
        updatedAssets: data.updatedAssets ?? parentAssets,
      },
    });
  } catch (e) {
    console.error('Gift Plan Error:', e);
    return NextResponse.json(
      {
        error:
          'ì£„ì†¡í•´ìš”, ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš” ğŸ˜­ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.',
        details: e instanceof Error ? e.message : String(e),
      },
      { status: 500 },
    );
  }
}
